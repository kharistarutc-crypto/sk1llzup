<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SkillzUp ‚Äî Aplikasi Pembelajaran</title>

    <!-- Fonts & libs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      /* Theme variables (default Light) */
      :root{
        --bg: #f1f5f9;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --accent: #2563eb;
        --accent-2: #7c3aed;
        --bubble-bg: linear-gradient(180deg,#fff,#f3f8ff);
        --emoji-size: 36px;
      }
      /* Dark theme */
      .theme-dark{
        --bg:#0b1220;
        --card:#071025;
        --text:#e6eef8;
        --muted:#9fb0d6;
        --accent:#60a5fa;
        --accent-2:#a78bfa;
        --bubble-bg: linear-gradient(180deg,#061022,#082033);
      }
      /* Pastel theme */
      .theme-pastel{
        --bg: linear-gradient(135deg,#fff0f6,#f0f9ff);
        --card: #fffaf6;
        --text: #102a43;
        --muted: #334e68;
        --accent: #ff7ab6;
        --accent-2: #7dd3fc;
        --bubble-bg: linear-gradient(180deg,#fff,#fff6f9);
      }

      *{box-sizing:border-box;font-family:'Poppins',sans-serif}
      html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
      /* NAV */
      nav{
        position:fixed;top:0;left:0;right:0;height:64px;background:var(--card);display:flex;align-items:center;gap:10px;padding:8px 12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);z-index:120;
      }
      .brand{font-weight:800;color:var(--accent);margin-right:8px}
      .nav-scroll{
        display:flex;gap:8px;overflow-x:auto;padding-bottom:6px; -webkit-overflow-scrolling: touch;
      }
      .nav-scroll::-webkit-scrollbar{height:8px}
      .nav-btn{flex:0 0 auto;padding:8px 12px;border-radius:12px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:600;white-space:nowrap}
      .nav-btn.active{background:var(--accent);color:white;box-shadow:0 6px 20px rgba(37,99,235,0.12)}
      .nav-right{margin-left:auto;display:flex;gap:8px;align-items:center}

      /* theme selector small */
      select#themeSelect{padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--text)}

      /* layout */
      .app{max-width:1100px;margin:84px auto 24px;padding:12px}
      .tab{display:none;animation:fadeSlide .28s ease}
      .tab.active{display:block}

      @keyframes fadeSlide{
        from{opacity:0; transform:translateY(6px)}
        to{opacity:1; transform:translateY(0)}
      }

      .card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 10px 30px rgba(2,6,23,0.05)}
      h1,h2{margin:0 0 10px 0;color:var(--accent)}
      p.sub{color:var(--muted);margin-bottom:12px}

      /* LOGIN */
      .login-wrap{display:flex;gap:12px;align-items:center;justify-content:center;min-height:320px}
      .login-form{width:100%;max-width:420px}
      label{display:block;margin-top:8px;color:var(--muted);font-weight:600}
      input[type="text"], input[type="date"], select, input[type="email"], input[type="password"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);margin-top:8px;background:transparent;color:var(--text)}
      .login-actions{display:flex;gap:8px;margin-top:12px}

      /* Dashboard menu bubbles vertical (on mobile scrollable) */
      .bubbles{
        display:flex;flex-direction:column;gap:12px;max-width:420px;
      }
      .bubble{
        display:flex;align-items:center;gap:12px;padding:14px;border-radius:14px;background:var(--bubble-bg);box-shadow:0 6px 18px rgba(2,6,23,0.06);cursor:pointer;transition:transform .18s;
      }
      .bubble:hover{transform:translateY(-6px)}
      .bubble .emoji{font-size:var(--emoji-size);opacity:0.95}
      .bubble .title{font-weight:700}
      .bubble .desc{color:var(--muted);font-size:13px}

      /* emoji floating */
      .emoji-float{position:fixed;pointer-events:none;z-index:30;opacity:0.9}
      @keyframes floatUp {
        0%{ transform:translateY(30vh) rotate(-20deg) scale(0.9); opacity:0}
        30%{ opacity:1 }
        100%{ transform:translateY(-10vh) rotate(20deg) scale(1.1); opacity:0}
      }

      /* ringkasan area */
      .flex-row{display:flex;gap:12px}
      .flex-row .half{flex:1}
      textarea, .output{min-height:120px;border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}

      /* small screens */
      @media (max-width:720px){
        .app{padding:12px}
        .bubbles{max-width:100%}
        nav{padding:6px 10px}
        .flex-row{flex-direction:column}
        .flex-row .half{width:100%}
      }

      /* theme color preview on bubbles */
      .bubble .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:var(--accent);color:#fff;font-weight:700}
    </style>
</head>
<body>

<!-- floating emojis (will be created by JS) -->
<div id="emojiLayer"></div>

<nav>
  <div class="brand">SkillzUp</div>
  <div class="nav-scroll" id="navScroll" style="flex:1">
    <button class="nav-btn active" data-target="tab-login">Login</button>
    <button class="nav-btn" data-target="tab-dashboard">Dashboard</button>
    <button class="nav-btn" data-target="tab-ringkasan">Ringkasan</button>
    <button class="nav-btn" data-target="tab-statistik">Statistik</button>
    <button class="nav-btn" data-target="tab-tes">Tes Gaya</button>
    <button class="nav-btn" data-target="tab-catatan">Catatan</button>
  </div>

  <div class="nav-right">
    <select id="themeSelect" title="Pilih Tema">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
      <option value="pastel">Pastel</option>
    </select>
    <div id="userLabel" style="font-weight:700;color:var(--accent)"></div>
  </div>
</nav>

<main class="app">
  <!-- LOGIN TAB -->
  <section id="tab-login" class="tab active">
    <div class="card">
      <h2>Masuk / Daftar</h2>
      <p class="sub">Isi data dasar terlebih dahulu. Data disimpan di perangkat (localStorage).</p>

      <div class="login-wrap">
        <form id="loginForm" class="login-form" onsubmit="return false">
          <label for="fullName">Nama lengkap</label>
          <input id="fullName" type="text" placeholder="Nama lengkap" required>

          <label for="email">Email</label>
          <input id="email" type="email" placeholder="contoh@domain.com" required>

          <label for="dob">Tanggal lahir</label>
          <input id="dob" type="date" required>

          <label for="gender">Jenis kelamin</label>
          <select id="gender" required>
            <option value="">Pilih...</option>
            <option value="pria">Pria</option>
            <option value="wanita">Wanita</option>
            <option value="lainnya">Lainnya</option>
          </select>

          <div class="login-actions">
            <button id="btnLogin" style="flex:1">Masuk & Simpan</button>
            <button id="btnClear" type="button" style="flex:0">Bersihkan</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="tab">
    <div class="card">
      <h2>Dashboard</h2>
      <p class="sub">Pilih fitur yang ingin digunakan ‚Äî menu tampil sebagai bubble persegi panjang.</p>

      <div class="flex" style="align-items:flex-start;gap:24px">
        <!-- bubbles area -->
        <div class="bubbles" id="bubbles">
          <div class="bubble" data-target="tab-ringkasan">
            <div class="emoji">üìö</div>
            <div>
              <div class="title">Ringkasan Materi</div>
              <div class="desc">Ringkas teks, foto (OCR) atau PDF.</div>
            </div>
            <div class="pill">Buka</div>
          </div>

          <div class="bubble" data-target="tab-statistik">
            <div class="emoji">üìà</div>
            <div>
              <div class="title">Statistik</div>
              <div class="desc">Lihat progres jam belajarmu.</div>
            </div>
            <div class="pill">Lihat</div>
          </div>

          <div class="bubble" data-target="tab-tes">
            <div class="emoji">üß†</div>
            <div>
              <div class="title">Tes Gaya Belajar</div>
              <div class="desc">Kenali gaya belajar & dapatkan saran.</div>
            </div>
            <div class="pill">Tes</div>
          </div>

          <div class="bubble" data-target="tab-catatan">
            <div class="emoji">üìù</div>
            <div>
              <div class="title">Catatan Pintar</div>
              <div class="desc">Simpan & ekspor catatanmu.</div>
            </div>
            <div class="pill">Buka</div>
          </div>
        </div>

        <!-- illustration / info -->
        <div style="flex:1;min-width:220px">
          <div class="card" id="dashIllustration" style="text-align:center">
            <div style="font-size:48px;margin-bottom:8px">‚ú®</div>
            <div style="color:var(--muted)">Nikmati pengalaman belajar personal ‚Äî ganti tema di pojok kanan.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- RINGKASAN -->
  <section id="tab-ringkasan" class="tab">
    <div class="card">
      <h2>Ringkasan Materi</h2>
      <p class="sub">Pilih sumber dan mode ringkasan lalu klik Ringkas.</p>

      <label>Pilih mode ringkasan</label>
      <select id="summaryMode">
        <option value="short">Singkat</option>
        <option value="medium">Sedang</option>
        <option value="detailed">Jelas</option>
      </select>

      <div class="flex-row" style="margin-top:12px">
        <div class="half">
          <label>Tulis manual / hasil ekstraksi</label>
          <textarea id="sourceText" placeholder="Tempel atau masukkan teks di sini..." class="output"></textarea>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnSummarize">Ringkas</button>
            <button id="btnClearSource" style="background:#666">Bersihkan</button>
          </div>
        </div>

        <div class="half">
          <label>Upload Foto (OCR)</label>
          <input id="imgFile" type="file" accept="image/*">
          <button id="btnOCR" style="margin-top:8px">Ambil teks dari foto</button>

          <hr style="margin:12px 0">

          <label>Upload PDF</label>
          <input id="pdfFile" type="file" accept="application/pdf">
          <button id="btnPdfExtract" style="margin-top:8px">Ekstrak teks dari PDF</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Hasil Ringkasan</label>
        <textarea id="resultText" class="output" readonly></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnExportSummary" style="background:var(--accent)">Ekspor ke PDF</button>
          <button id="btnCopySummary" style="background:var(--accent-2)">Salin</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STATISTIK -->
  <section id="tab-statistik" class="tab">
    <div class="card">
      <h2>Statistik Belajar</h2>
      <p class="sub">Jam aktivitas per fitur (penyederhanaan statistik untuk demo).</p>
      <div style="display:flex;gap:12px;align-items:center">
        <input id="addHoursInput" type="number" min="0" step="1" placeholder="1" style="width:110px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
        <button id="btnAddHours">Tambahkan jam hari ini</button>
        <button id="btnResetStats" style="background:#d94a4a">Reset Statistik</button>
      </div>

      <div style="margin-top:14px">
        <canvas id="statChart" height="120"></canvas>
      </div>
    </div>
  </section>

  <!-- TES GAYA -->
  <section id="tab-tes" class="tab">
    <div class="card">
      <h2>Tes Gaya Belajar</h2>
      <p class="sub">Pilih jawaban, lalu klik 'Lihat Hasil & Saran'.</p>

      <label>Pertanyaan 1</label>
      <select id="q1">
        <option value="visual">Melihat gambar/diagram</option>
        <option value="auditory">Mendengar penjelasan</option>
        <option value="kinesthetic">Praktik langsung</option>
      </select>

      <label>Pertanyaan 2</label>
      <select id="q2">
        <option value="visual">Membuat catatan berwarna</option>
        <option value="auditory">Diskusi/rekaman</option>
        <option value="kinesthetic">Latihan langsung</option>
      </select>

      <label>Pertanyaan 3</label>
      <select id="q3">
        <option value="visual">Menyimak slide/grafik</option>
        <option value="auditory">Mendengarkan penjelasan</option>
        <option value="kinesthetic">Praktik & eksperimen</option>
      </select>

      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnEvaluate">Lihat Hasil & Saran</button>
      </div>

      <div id="testResult" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- CATATAN -->
  <section id="tab-catatan" class="tab">
    <div class="card">
      <h2>Catatan Pintar</h2>
      <label>Judul</label>
      <input id="noteTitle">
      <label>Isi</label>
      <textarea id="noteBody" class="output"></textarea>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnSaveNote">Simpan</button>
        <button id="btnExportNote" style="background:#6b7280">Ekspor PDF</button>
      </div>

      <h3 style="margin-top:12px">Daftar Catatan</h3>
      <div id="notesList"></div>
    </div>
  </section>

</main>

<script>
/* ---------------------------
   Small helpers & state
   --------------------------- */
const root = document.documentElement;
const themeSelect = document.getElementById('themeSelect');
const navBtns = Array.from(document.querySelectorAll('.nav-btn'));
const tabElems = Array.from(document.querySelectorAll('.tab'));
const userLabel = document.getElementById('userLabel');
const emojiLayer = document.getElementById('emojiLayer');

const STORAGE_USER = 'skillzup_user_v2';
const STORAGE_THEME = 'skillzup_theme_v2';
const STORAGE_STATS = 'skillzup_stats_v2';
const STORAGE_NOTES = 'skillzup_notes_v2';

let stats = JSON.parse(localStorage.getItem(STORAGE_STATS)||'{}');
if(!stats.counts) stats.counts = { ringkas:0, ocr:0, pdf:0, tes:0, notes:0 };

/* ---------------------------
   THEME
   --------------------------- */
function applyTheme(name){
  document.body.classList.remove('theme-dark','theme-pastel');
  if(name==='dark') document.body.classList.add('theme-dark');
  if(name==='pastel') document.body.classList.add('theme-pastel');
  localStorage.setItem(STORAGE_THEME, name);
}
themeSelect.addEventListener('change', ()=> applyTheme(themeSelect.value));
const savedTheme = localStorage.getItem(STORAGE_THEME)||'light';
themeSelect.value = savedTheme;
applyTheme(savedTheme);

/* ---------------------------
   NAV / TABS (mobile scrollable)
   --------------------------- */
document.querySelectorAll('.nav-btn').forEach(b=>{
  b.addEventListener('click', (ev)=>{
    document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const t = b.dataset.target;
    showTab(t);
    // smooth scroll nav so selected visible (mobile)
    b.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  });
});
function showTab(id){
  tabElems.forEach(t=>t.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  // small animation spawn emojis / illustration
  spawnEmojis(3);
}

/* ---------------------------
   LOGIN
   --------------------------- */
const loginForm = document.getElementById('loginForm');
const btnLogin = document.getElementById('btnLogin');
const btnClear = document.getElementById('btnClear');

function loadUser(){
  const u = JSON.parse(localStorage.getItem(STORAGE_USER)||'null');
  if(u){
    userLabel.textContent = u.name;
    // hide login tab, show dashboard
    // set nav active to dashboard
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.nav-btn[data-target="tab-dashboard"]').classList.add('active');
    showTab('tab-dashboard');
  } else {
    // show login
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.nav-btn[data-target="tab-login"]').classList.add('active');
    showTab('tab-login');
  }
}
btnLogin.addEventListener('click', ()=>{
  const name = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim();
  const dob = document.getElementById('dob').value;
  const gender = document.getElementById('gender').value;
  if(!name || !email || !dob || !gender){ alert('Lengkapi semua field.'); return; }
  localStorage.setItem(STORAGE_USER, JSON.stringify({name,email,dob,gender}));
  userLabel.textContent = name;
  alert('Profil tersimpan. Selamat datang, '+name+'!');
  loadUser();
});
btnClear.addEventListener('click', ()=>{
  document.getElementById('fullName').value='';
  document.getElementById('email').value='';
  document.getElementById('dob').value='';
  document.getElementById('gender').value='';
});

/* ---------------------------
   Dashboard bubble clicks
   --------------------------- */
document.getElementById('bubbles').addEventListener('click', (ev)=>{
  const b = ev.target.closest('.bubble');
  if(!b) return;
  const t = b.dataset.target;
  // set nav active
  document.querySelectorAll('.nav-btn').forEach(nb=>nb.classList.remove('active'));
  const navBtn = document.querySelector(`.nav-btn[data-target="${t}"]`);
  if(navBtn) navBtn.classList.add('active');
  showTab(t);
});

/* ---------------------------
   Floating emojis generator
   --------------------------- */
const emojiList = ['‚ú®','üìö','üß†','üìà','üìù','üéØ','üí°','üî•'];
function spawnEmojis(count=3){
  for(let i=0;i<count;i++){
    const e = document.createElement('div');
    e.className = 'emoji-float';
    const emoji = emojiList[Math.floor(Math.random()*emojiList.length)];
    e.textContent = emoji;
    const size = 24 + Math.random()*32;
    e.style.fontSize = size+'px';
    e.style.left = (10 + Math.random()*80) + '%';
    e.style.bottom = '-10%';
    e.style.animation = `floatUp ${6 + Math.random()*6}s linear`;
    e.style.opacity = 0;
    emojiLayer.appendChild(e);
    setTimeout(()=> e.remove(), 8000 + Math.random()*4000);
  }
}

/* spawn a few on load */
spawnEmojis(6);
setInterval(()=>spawnEmojis(2), 5000);

/* ---------------------------
   Ringkasan (text / OCR / PDF)
   --------------------------- */
function splitSentences(text){
  if(!text) return [];
  // naive split
  return text.replace(/\n+/g,'. ').split(/(?<=[.?!])\s+/).map(s=>s.trim()).filter(Boolean);
}
function summarize(text, mode){
  const s = splitSentences(text);
  if(s.length===0) return '';
  if(mode==='short') return s.slice(0,1).join(' ');
  if(mode==='medium') return s.slice(0,3).join(' ');
  if(mode==='detailed') return s.slice(0,6).join(' ');
  return s.slice(0,3).join(' ');
}

document.getElementById('btnSummarize').addEventListener('click', ()=>{
  const src = document.getElementById('sourceText').value || '';
  if(!src) return alert('Masukkan teks atau ekstrak sumber dulu.');
  const mode = document.getElementById('summaryMode').value;
  const out = summarize(src, mode);
  document.getElementById('resultText').value = out;
  incrementStat('ringkas');
});

document.getElementById('btnClearSource').addEventListener('click', ()=>{
  document.getElementById('sourceText').value = '';
  document.getElementById('resultText').value = '';
});

/* OCR foto */
document.getElementById('btnOCR').addEventListener('click', async ()=>{
  const file = document.getElementById('imgFile').files[0];
  if(!file) return alert('Pilih file foto dulu.');
  try{
    const res = await Tesseract.recognize(file, 'eng', { logger: m => {} });
    document.getElementById('sourceText').value = res.data.text;
    alert('OCR selesai, teks dimuat.');
    incrementStat('ocr');
  } catch(err){ alert('OCR gagal: '+err.message); }
});

/* ekstrak PDF */
document.getElementById('btnPdfExtract').addEventListener('click', async ()=>{
  const file = document.getElementById('pdfFile').files[0];
  if(!file) return alert('Pilih file PDF dulu.');
  try{
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let full = '';
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const str = content.items.map(it=>it.str).join(' ');
      full += str + '\n\n';
    }
    document.getElementById('sourceText').value = full;
    alert('Teks dari PDF berhasil dimuat.');
    incrementStat('pdf');
  } catch(err){ alert('Ekstrak PDF gagal: '+err.message); }
});

/* export summary to PDF */
document.getElementById('btnExportSummary').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const title = 'Ringkasan';
  const text = document.getElementById('resultText').value || document.getElementById('sourceText').value || '';
  const lines = pdf.splitTextToSize(text, 180);
  pdf.setFontSize(14); pdf.text(title, 15, 20);
  pdf.setFontSize(11); pdf.text(lines, 15, 30);
  pdf.save('ringkasan.pdf');
});

/* copy summary */
document.getElementById('btnCopySummary').addEventListener('click', async ()=>{
  const t = document.getElementById('resultText').value;
  if(!t) return alert('Belum ada ringkasan.');
  await navigator.clipboard.writeText(t);
  alert('Ringkasan disalin ke clipboard.');
});

/* ---------------------------
   Statistik
   --------------------------- */
const statCtx = document.getElementById('statChart').getContext('2d');
let statChart;

function ensureStats(){
  const s = JSON.parse(localStorage.getItem(STORAGE_STATS) || 'null');
  if(s) stats = s;
  else localStorage.setItem(STORAGE_STATS, JSON.stringify(stats));
}
ensureStats();

function incrementStat(key){
  stats.counts[key] = (stats.counts[key] || 0) + 1;
  stats.lastUpdated = new Date().toISOString();
  localStorage.setItem(STORAGE_STATS, JSON.stringify(stats));
  renderStatsChart();
  // small visual
  spawnEmojis(1);
}

document.getElementById('btnAddHours').addEventListener('click', ()=>{
  const v = Number(document.getElementById('addHoursInput').value) || 1;
  stats.hoursToday = (stats.hoursToday || 0) + v;
  localStorage.setItem(STORAGE_STATS, JSON.stringify(stats));
  renderStatsChart();
});

document.getElementById('btnResetStats').addEventListener('click', ()=>{
  if(!confirm('Reset semua statistik?')) return;
  stats = { counts: { ringkas:0, ocr:0, pdf:0, tes:0, notes:0 }, hoursToday:0 };
  localStorage.setItem(STORAGE_STATS, JSON.stringify(stats));
  renderStatsChart();
});

function renderStatsChart(){
  const labels = ['Ringkas','OCR Foto','PDF','Tes','Catatan'];
  const data = labels.map(l=>{
    if(l==='Ringkas') return stats.counts.ringkas || 0;
    if(l==='OCR Foto') return stats.counts.ocr || 0;
    if(l==='PDF') return stats.counts.pdf || 0;
    if(l==='Tes') return stats.counts.tes || 0;
    if(l==='Catatan') return stats.counts.notes || 0;
    return 0;
  });

  if(statChart) statChart.destroy();
  statChart = new Chart(statCtx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Aktivitas', data, backgroundColor: 'rgba(37,99,235,0.9)' }] },
    options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true }} }
  });
}
renderStatsChart();

/* ---------------------------
   Tes Gaya Belajar + Saran
   --------------------------- */
document.getElementById('btnEvaluate').addEventListener('click', ()=>{
  const q1 = document.getElementById('q1').value;
  const q2 = document.getElementById('q2').value;
  const q3 = document.getElementById('q3').value;
  const tally = { visual:0, auditory:0, kinesthetic:0 };
  [q1,q2,q3].forEach(v=> tally[v]++);
  let winner = Object.entries(tally).sort((a,b)=>b[1]-a[1])[0][0];
  const label = { visual:'Visual', auditory:'Auditori', kinesthetic:'Kinestetik' }[winner];
  const adv = {
    visual: {
      title:'Visual ‚Äî Rekomendasi',
      bullets:[
        'Buat mindmap & diagram saat belajar.',
        'Gunakan highlight dan warna pada catatan.',
        'Tonton video atau presentasi yang menampilkan grafik.'
      ],
      schedule:'Sesi 25‚Äì30 menit, review dengan membuat sketsa ringkasan.'
    },
    auditory:{
      title:'Auditori ‚Äî Rekomendasi',
      bullets:[
        'Rekam penjelasan dan dengarkan ulang.',
        'Diskusi kelompok atau baca keras-keras.',
        'Gunakan podcast atau materi audio bila tersedia.'
      ],
      schedule:'Sesi 30 menit sambil merekam ringkasan, lalu dengarkan saat istirahat.'
    },
    kinesthetic:{
      title:'Kinestetik ‚Äî Rekomendasi',
      bullets:[
        'Praktik langsung: coding, eksperimen, latihan.',
        'Gunakan proyek mini untuk menerapkan konsep.',
        'Ajar orang lain untuk memperkuat keterampilan.'
      ],
      schedule:'Sesi 20‚Äì40 menit praktek langsung, lalu refleksi singkat.'
    }
  };

  const r = adv[winner];
  const container = document.getElementById('testResult');
  container.innerHTML = `<div style="background:var(--card);padding:12px;border-radius:10px">
    <strong>${label}</strong>
    <div style="margin-top:8px"><em>${r.title}</em></div>
    <ul style="margin-top:8px">${r.bullets.map(x=>'<li>'+x+'</li>').join('')}</ul>
    <div style="margin-top:8px"><strong>Rencana singkat:</strong> ${r.schedule}</div>
  </div>`;
  incrementStat('tes');
});

/* ---------------------------
   Catatan Pintar
   --------------------------- */
function loadNotes(){
  return JSON.parse(localStorage.getItem(STORAGE_NOTES) || '[]');
}
function saveNotes(notes){
  localStorage.setItem(STORAGE_NOTES, JSON.stringify(notes));
}
function renderNotes(){
  const list = loadNotes();
  const container = document.getElementById('notesList');
  container.innerHTML = '';
  if(list.length===0){ container.innerHTML = '<div style="color:var(--muted)">Belum ada catatan.</div>'; return; }
  list.slice().reverse().forEach((n,i)=>{
    const idx = list.length-1-i;
    const el = document.createElement('div'); el.className='card';
    el.style.marginBottom='8px';
    el.innerHTML = `<div style="display:flex;gap:8px;align-items:flex-start">
      <div style="flex:1">
        <strong>${n.title||'Tanpa Judul'}</strong>
        <div style="color:var(--muted);margin-top:6px">${n.body.slice(0,240)}${n.body.length>240?'...':''}</div>
        <div style="margin-top:8px;color:var(--muted);font-size:12px">Tersimpan: ${new Date(n.created).toLocaleString()}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button data-idx="${idx}" class="btn-open">Buka</button>
        <button data-idx="${idx}" class="btn-del" style="background:#fee2e2;color:#b91c1c">Hapus</button>
      </div>
    </div>`;
    container.appendChild(el);
  });

  // add events
  container.querySelectorAll('.btn-open').forEach(b=>{
    b.addEventListener('click', ev=>{
      const idx = Number(ev.currentTarget.dataset.idx);
      const notes = loadNotes();
      const n = notes[idx];
      document.getElementById('noteTitle').value = n.title;
      document.getElementById('noteBody').value = n.body;
      // go to notes tab
      document.querySelectorAll('.nav-btn').forEach(nb=>nb.classList.remove('active'));
      document.querySelector('.nav-btn[data-target="tab-catatan"]').classList.add('active');
      showTab('tab-catatan');
    });
  });
  container.querySelectorAll('.btn-del').forEach(b=>{
    b.addEventListener('click', ev=>{
      const idx = Number(ev.currentTarget.dataset.idx);
      if(!confirm('Hapus catatan ini?')) return;
      const notes = loadNotes(); notes.splice(idx,1); saveNotes(notes); renderNotes();
      incrementStat('notes');
    });
  });
}
document.getElementById('btnSaveNote').addEventListener('click', ()=>{
  const t = document.getElementById('noteTitle').value.trim();
  const b = document.getElementById('noteBody').value.trim();
  if(!b) return alert('Isi catatan terlebih dahulu');
  const notes = loadNotes();
  notes.push({ title:t, body:b, created: new Date().toISOString() });
  saveNotes(notes);
  document.getElementById('noteTitle').value=''; document.getElementById('noteBody').value='';
  renderNotes();
  incrementStat('notes');
});
document.getElementById('btnExportNote').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const title = document.getElementById('noteTitle').value || 'Catatan';
  const body = document.getElementById('noteBody').value || '';
  const lines = pdf.splitTextToSize(body, 180);
  pdf.setFontSize(16); pdf.text(title, 15, 20);
  pdf.setFontSize(12); pdf.text(lines, 15, 30);
  pdf.save(`${title.replace(/\s+/g,'_')}.pdf`);
});

/* ---------------------------
   Init & load persisted
   --------------------------- */
function init(){
  // load saved theme
  const savedTheme = localStorage.getItem(STORAGE_THEME) || 'light';
  themeSelect.value = savedTheme;
  if(savedTheme==='dark') document.body.classList.add('theme-dark');
  if(savedTheme==='pastel') document.body.classList.add('theme-pastel');

  // load user
  loadUser();

  renderNotes();
  renderStatsChart();
}
init();

</script>
</body>
</html>
